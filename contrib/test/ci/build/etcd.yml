---

- name: get etcd version from kubernetes github 
  shell: 'curl -s  "https://raw.githubusercontent.com/kubernetes/kubernetes/3ccce7cf7812e7174801c4269019246cdb763cec/hack/lib/etcd.sh" | grep ETCD_VERSION: | grep -o "[1-9]\.[1-9]\.[1-9]"'
  register: etcd_version 
  
# TODO: change for other architectures 
- name: download etcd
  get_url: 
    url: "https://github.com/coreos/etcd/releases/download/v{{ etcd_version.stdout }}/etcd-v{{ etcd_version.stdout }}-linux-amd64.tar.gz"
    dest: "{{ ansible_env.GOPATH }}/src/k8s.io/kubernetes/third_party"

- name: prevent downloading in the etcd script
  ansible.builtin.replace:
    path: "{{ ansible_env.GOPATH }}/src/k8s.io/kubernetes/hack/lib/etcd.sh" 
    regexp: ".*https://github.com.*|kube::util::download_file.*"
    replace: "#removed by ansible in build/etcd.yml"

