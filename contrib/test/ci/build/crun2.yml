---
- name: Remove existing crun directory (if it exists)
  file:
    path: "{{ ansible_env.GOPATH }}/src/github.com/containers/crun"
    state: absent
    force: yes

- name: clone crun source repo
  git:
    repo: "https://github.com/containers/crun.git"
    dest: "{{ ansible_env.GOPATH }}/src/github.com/containers/crun"
    force: yes
    version: main

- name: Fetch the PR changes
  shell: |
    cd {{ ansible_env.GOPATH }}/src/github.com/containers/crun
    git fetch origin pull/1574/head:pr-1574
    git checkout pr-1574
  args:
    executable: /bin/bash

- name: Verify the PR branch is checked out
  shell: |
    cd {{ ansible_env.GOPATH }}/src/github.com/containers/crun
    git branch --show-current
  register: current_branch
  failed_when: current_branch.stdout != "pr-1574"

- name: Run autogen.sh
  command: "{{ ansible_env.GOPATH }}/src/github.com/containers/crun/autogen.sh"
  args:
    chdir: "{{ ansible_env.GOPATH }}/src/github.com/containers/crun"

- name: Run configure
  command: "{{ ansible_env.GOPATH }}/src/github.com/containers/crun/configure --enable-embedded-yajl"
  args:
    chdir: "{{ ansible_env.GOPATH }}/src/github.com/containers/crun"

- name: run crun clean
  make:
    target: clean
    chdir: "{{ ansible_env.GOPATH }}/src/github.com/containers/crun"

- name: build crun
  make:
    chdir: "{{ ansible_env.GOPATH }}/src/github.com/containers/crun"

- name: install crun
  make:
    target: "install"
    chdir: "{{ ansible_env.GOPATH }}/src/github.com/containers/crun"
