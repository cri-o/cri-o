---
- hosts: localhost, all
  become: yes
  environment:
    GOPATH: /usr/go
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  tags:
    - e2e
  tasks:
    - name: setup
      include: "setup.yml"

    - name: build and run crio 
      include: "build/cri-o.yml"

    - name: enable and start CRI-O
      become: yes
      systemd:
        name: crio
        state: started
        enabled: yes
        daemon_reload: yes

    - name: run k8s e2e tests
      include: "e2e.yml"
      environment:
        KUBECONFIG: /var/run/kubernetes/admin.kubeconfig

    - name: changing permission of temp file
      become: yes
      file: dest=/tmp/artifacts owner=deadbeef group=deadbeef mode=0777 recurse=yes

- hosts: localhost, all
  become: yes
  environment:
    GOPATH: /usr/go
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  tags:
    - e2e-features
  tasks:
    - name: setup
      include: "setup.yml" 

    - name: build and run crio 
      include: "build/cri-o.yml"

    - name: enable and start CRI-O
      become: yes
      systemd:
        name: crio
        state: started
        enabled: yes
        daemon_reload: yes
    - name: clone build and install kubernetes
      include: "build/kubernetes.yml"
      vars:
        force_clone: true
        k8s_git_version: "master"
        k8s_github_fork: "kubernetes"
        crio_socket: "/run/crio/crio.sock"
      when: "(cgroupv2 is undefined) or (cgroupv2 == False) | bool"
    
    - name: clone build and install kubernetes for cgroup v2
      include: "build/kubernetes.yml"
      vars:
        force_clone: true
        k8s_git_version: "master"
        k8s_github_fork: "kubernetes"
        crio_socket: "/run/crio/crio.sock"
      when: "cgroupv2 | bool"

    - name: run k8s e2e features tests
      include: "e2e-features.yml"
      environment:
        KUBECONFIG: /var/run/kubernetes/admin.kubeconfig

    - name: changing permission of temp file
      become: yes
      file: dest=/tmp/artifacts owner=deadbeef group=deadbeef mode=0777 recurse=yes
