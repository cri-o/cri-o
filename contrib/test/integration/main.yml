---

- hosts: '{{ subjects | default("all") }}'
  gather_facts: False  # Requires low-level ansible-dependencies
  # Cannot use vars.yml - it references magic variables from setup module
  tags:
    - setup
  tasks:
    - name: Ansible setup-module dependencies are installed, ignoring errors (setup runs next).
      raw: $(type -P dnf || type -P yum) install -y python2 python2-dnf libselinux-python
      ignore_errors: True

    - name: Gather only networking facts for speed
      setup:
        gather_subset: network

    - name: Variables from vars.yml are hauled in after setup
      include_vars: "{{ playbook_dir }}/vars.yml"

    - name: Global environment are defined, but can be overriden on a task-by-task basis.
      set_fact:
        extra_storage_opts: >
            {%- if ansible_distribution in ["RedHat", "CentOS"] -%}
                "--storage-opt overlay.override_kernel_check=1"
            {%- else -%}
                ""
            {%- endif -%}
        environment_variables:
            PATH: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:{{ go_path }}/bin:/usr/local/go/bin"
            GOPATH: "{{ go_path }}"
            KUBERNETES_PROVIDER: "local"
            KUBECONFIG: "/var/run/kubernetes/admin.kubeconfig"
            CGROUP_MANAGER: "cgroupfs"
            STORAGE_OPTS: '--storage-driver=overlay {{ extra_storage_opts | default("") | trim }}'


- hosts: '{{ subjects | default("none") }}'
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  tags:
    - setup
  tasks:
    - name: CRI-O source is available on every subject
      include: github.yml


- hosts: '{{ subjects | default("all") }}'
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  environment: '{{ environment_variables }}'
  tags:
    - setup
  tasks:
    - name: set up the system
      include: system.yml

    - name: install Golang tools
      include: golang.yml

    - name: clone build and install bats
      include: "build/bats.yml"

    - name: clone build and install cri-tools
      include: "build/cri-tools.yml"

    - name: clone build and install kubernetes
      include: "build/kubernetes.yml"

    - name: clone build and install runc
      include: "build/runc.yml"

    - name: clone build and install networking plugins
      include: "build/plugins.yml"


- hosts: '{{ subjects | default("all") }}'
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  environment: '{{ environment_variables }}'
  tasks:
    - name: Build and install cri-o
      include: "build/cri-o.yml"
      tags:
        - always

    - name: run cri-o integration tests
      include: test.yml
      tags:
        - integration

    - name: run k8s e2e tests
      include: e2e.yml
      tags:
        - e2e
