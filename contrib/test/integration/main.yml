- hosts: all
  remote_user: root
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  tags:
    - setup
  pre_tasks:
    - name: set up the system
      include: system.yml

    - name: install Golang tools
      include: golang.yml

  roles:
    - role: git_repo_cloned
      git_ops: '{{ git_operations }}'
      always_force: False

  post_tasks:

    - name: Install ETCD and Build Kubernetes
      include: "build/kubernetes.yml"

    - name: Build runc
      include: "build/runc.yml"

    - name: Build networking plugins
      include: "build/plugins.yml"


- hosts: all
  remote_user: root
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  tags:
    - integration
    - e2e
  roles:
    - role: git_repo_cloned
      git_ops: '{{ git_operations }}'
      always_force: True

  post_tasks:
    - name: Install BATS
      include: "install/bats.yml"

    - name: Install cri-tools
      include: "install/cri-tools.yml"

    - name: Re-Install ETCD and Re-Build Kubernetes
      include: "build/kubernetes.yml"

    - name: Re-Install kubernetes
      include: "install/kubernetes.yml"

    - name: Build runc
      include: "build/runc.yml"

    - name: install runc
      include: "install/runc.yml"

    - name: Build networking plugins
      include: "build/plugins.yml"

    - name: Install networking plugins
      include: "install/plugins.yml"

    - name: Build CRI-O
      include: "build/cri-o.yml"

    - name: Install CRI-O
      include: "install/cri-o.yml"


- hosts: all
  remote_user: root
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  tags:
    - integration
  tasks:
    - name: run cri-o integration tests
      include: test.yml

- hosts: all
  remote_user: root
  vars_files:
    - "{{ playbook_dir }}/vars.yml"
  tags:
    - e2e
  tasks:
    - name: run k8s e2e tests
      include: e2e.yml
