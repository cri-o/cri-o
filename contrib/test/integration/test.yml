---

- name: clone build and install cri-tools
  include: "build/cri-tools.yml"

- name: Make testing output verbose so it can be converted to xunit
  lineinfile:
    dest: "{{ go_path }}/src/k8s.io/kubernetes/hack/make-rules/test.sh"
    line: ' go test -v "${goflags[@]:+${goflags[@]}}" \'
    regexp: ' go test \"\$'
    state: present

- name: ensure directory exists for integration results
  file:
    path: "{{ artifacts }}"
    state: directory

- block:

    - name: Disable swap during integration tests
      command: 'swapoff -a'
      when: not integration_swap_enabled

    - name: Disable selinux during integration tests
      command: 'setenforce 0'
      when: not integration_selinux_enabled

    - name: run integration tests
      shell: "make localintegration >& {{ artifacts }}/testout.txt"
      args:
        chdir: "{{ cri_o_dest_path }}"
      async: 5400
      poll: 30

  always:

    - name: Re-enable SELinux after integration tsts
      command: 'setenforce 1'

    - name: Re-enalbe swap after integration tests
      command: 'swapon -a'
