---

- name: Make testing output verbose so it can be converted to xunit
  lineinfile:
    dest: "{{ ansible_env.GOPATH }}/src/k8s.io/kubernetes/hack/make-rules/test.sh"
    line: ' go test -v "${goflags[@]:+${goflags[@]}}" \  # Added by ansible from test.yml'
    regexp: ' go test \"\$'
    state: present

- name: ensure directory exists for e2e reports
  file:
    path: "{{ artifacts }}"
    state: directory

- block:

    - name: Disable selinux during integration tests
      command: 'setenforce 0'
      when: not integration_selinux_enabled

    - name: run integration tests
      shell: "make localintegration >& {{ crio_integration_filepath }}"
      args:
        chdir: "{{ ansible_env.GOPATH }}/src/github.com/cri-o/cri-o"
      environment: '{{ int_test_env }}'  # from vars.yml and main.yml
      async: '{{ 60 * 30 }}'  # seconds
      poll: 30

    - name: run integration tests with userNS enabled + alternate results file
      shell: "make localintegration >& {{ crio_integration_userns_filepath }}"
      args:
        chdir: "{{ ansible_env.GOPATH }}/src/github.com/cri-o/cri-o"
      environment: '{{ int_test_env | combine(userns_int_test_env) }} '
      async: '{{ 60 * 30 }}'  # seconds
      poll: 30

  always:

    - name: Re-enable SELinux after integration tests
      command: 'setenforce 1'
    # this item is only for AMI updates. We get issues of conflicting device names and ip addresses
    # because we run both integration and e2e tests on the same box.
    # so we delete the device before running e2e
    # also, we use the command package, rather than nmcli, because rhel 7 has ansible version 2.4.2, which doesn't
    # have the fix: https://github.com/ansible/ansible/issues/48055
    - name: clear
      command: nmcli dev delete cni0
      ignore_errors: yes
